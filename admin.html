<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YMF Messaging Platform Admin Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
    }
    h1 {
      color: #8b1453;
    }
    #adminPanel {
      display: none;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li.chatroom-item, li.member-item {
      background: white;
      margin: 5px 0;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 3px #ccc;
    }
    .editable-chatroom-name {
      cursor: text;
      margin-right: 10px;
      display: inline-block;
      min-width: 150px;
      outline: none;
      border-bottom: 1px dotted #999;
    }
    button {
      margin-left: 5px;
      background-color: #8b1453;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    label {
      margin-right: 10px;
      cursor: pointer;
    }
    #statusMessage {
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>
  <h1>YMF Messaging Platform Admin Panel</h1>
  <div id="loginMessage">Checking login...</div>

  <div id="adminPanel">
    <button id="logoutBtn">Logout</button>

    <h2>Chatrooms</h2>
    <input type="text" id="newChatroomName" placeholder="New chatroom name" />
    <button id="createChatroomBtn">Create Chatroom</button>
    <ul id="chatroomsList"></ul>

    <h2>Members</h2>
    <ul id="membersList"></ul>

    <div id="statusMessage"></div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCp94HHzIFiZh5kZREi7ZIVVL67IMnHEXw",
      authDomain: "ymf-messaging-platform.firebaseapp.com",
      projectId: "ymf-messaging-platform",
      storageBucket: "ymf-messaging-platform.firebasestorage.app",
      messagingSenderId: "820655157281",
      appId: "1:820655157281:web:9713621443c068abd73360"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Admin emails
    const adminEmails = ["ian@ianchalkmusic.com", "sue.chalk@hotmail.co.uk"];

    // UI elements
    const adminPanel = document.getElementById('adminPanel');
    const loginMessage = document.getElementById('loginMessage');
    const chatroomsList = document.getElementById('chatroomsList');
    const membersList = document.getElementById('membersList');
    const createChatroomBtn = document.getElementById('createChatroomBtn');
    const newChatroomNameInput = document.getElementById('newChatroomName');
    const logoutBtn = document.getElementById('logoutBtn');
    const statusMessage = document.getElementById('statusMessage');

    let currentUser = null;

    // Check auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        if (adminEmails.includes(user.email)) {
          loginMessage.style.display = 'none';
          adminPanel.style.display = 'block';
          loadChatrooms();
          loadMembers();
        } else {
          loginMessage.textContent = "Access denied: You are not an admin.";
          loginMessage.style.color = 'red';
          loginMessage.style.display = 'block';
          adminPanel.style.display = 'none';
        }
      } else {
        loginMessage.textContent = "Please sign in to access admin panel.";
        loginMessage.style.color = 'black';
        loginMessage.style.display = 'block';
        adminPanel.style.display = 'none';
        // Trigger sign in popup
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
          loginMessage.textContent = "Sign-in error: " + error.message;
          loginMessage.style.color = 'red';
        });
      }
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    // Load chatrooms from Firestore
    function loadChatrooms() {
      chatroomsList.innerHTML = '';
      db.collection('chatrooms').orderBy('name').get().then(snapshot => {
        snapshot.forEach(doc => {
          const chatroom = doc.data();
          const chatroomId = doc.id;

          const li = document.createElement('li');
          li.className = 'chatroom-item';

          const nameSpan = document.createElement('span');
          nameSpan.textContent = chatroom.name;
          nameSpan.contentEditable = true;
          nameSpan.classList.add('editable-chatroom-name');
          nameSpan.addEventListener('blur', () => {
            const newName = nameSpan.textContent.trim();
            if (newName && newName !== chatroom.name) {
              db.collection('chatrooms').doc(chatroomId).update({ name: newName })
                .then(() => {
                  statusMessage.textContent = `Chatroom renamed to "${newName}".`;
                  setTimeout(() => statusMessage.textContent = '', 3000);
                })
                .catch(error => {
                  alert('Error renaming chatroom: ' + error.message);
                  nameSpan.textContent = chatroom.name;
                });
            } else {
              nameSpan.textContent = chatroom.name;
            }
          });

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => {
            if (confirm(`Delete chatroom "${chatroom.name}"?`)) {
              db.collection('chatrooms').doc(chatroomId).delete()
                .then(() => {
                  statusMessage.textContent = `Chatroom "${chatroom.name}" deleted.`;
                  setTimeout(() => statusMessage.textContent = '', 3000);
                  loadChatrooms();
                })
                .catch(error => {
                  alert('Error deleting chatroom: ' + error.message);
                });
            }
          });

          li.appendChild(nameSpan);
          li.appendChild(deleteBtn);

          chatroomsList.appendChild(li);
        });
      });
    }

    createChatroomBtn.addEventListener('click', () => {
      const name = newChatroomNameInput.value.trim();
      if (!name) {
        alert('Please enter a chatroom name.');
        return;
      }
      // Check if chatroom name already exists
      db.collection('chatrooms').where('name', '==', name).get().then(snapshot => {
        if (!snapshot.empty) {
          alert('A chatroom with that name already exists.');
        } else {
          db.collection('chatrooms').add({ name: name })
            .then(() => {
              statusMessage.textContent = `Chatroom "${name}" created.`;
              setTimeout(() => statusMessage.textContent = '', 3000);
              newChatroomNameInput.value = '';
              loadChatrooms();
            })
            .catch(error => {
              alert('Error creating chatroom: ' + error.message);
            });
        }
      });
    });

    // Load members from Firestore
    function loadMembers() {
      membersList.innerHTML = '';
      db.collection('users').orderBy('fullName').get().then(snapshot => {
        snapshot.forEach(doc => {
          const user = doc.data();
          const userId = doc.id;

          const li = document.createElement('li');
          li.className = 'member-item';

          const nameSpan = document.createElement('span');
          nameSpan.textContent = user.fullName + ' (' + user.email + ')';
          li.appendChild(nameSpan);

          const approveBtn = document.createElement('button');
          approveBtn.textContent = user.approved ? 'Approved' : 'Approve';
          approveBtn.disabled = user.approved;
          approveBtn.addEventListener('click', () => {
            db.collection('users').doc(userId).update({ approved: true })
              .then(() => {
                approveBtn.textContent = 'Approved';
                approveBtn.disabled = true;
                statusMessage.textContent = `User "${user.fullName}" approved.`;
                setTimeout(() => statusMessage.textContent = '', 3000);
              })
              .catch(error => alert('Error approving user: ' + error.message));
          });
          li.appendChild(approveBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => {
            if (confirm(`Delete user "${user.fullName}"?`)) {
              db.collection('users').doc(userId).delete()
                .then(() => {
                  statusMessage.textContent = `User "${user.fullName}" deleted.`;
                  setTimeout(() => statusMessage.textContent = '', 3000);
                  loadMembers();
                })
                .catch(error => alert('Error deleting user: ' + error.message));
            }
          });
          li.appendChild(deleteBtn);

          // Show chatrooms user belongs to
          const chatroomsSpan = document.createElement('span');
          chatroomsSpan.textContent = ' Chatrooms: ';
          li.appendChild(chatroomsSpan);

          // Load all chatrooms for this user and allow adding/removing
          db.collection('chatrooms').orderBy('name').get().then(chatroomsSnapshot => {
            chatroomsSnapshot.forEach(chatDoc => {
              const chatroomId = chatDoc.id;
              const chatroomName = chatDoc.data().name;

              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = `${userId}_${chatroomId}`;
              checkbox.checked = user.chatrooms && user.chatrooms.includes(chatroomId);
              checkbox.addEventListener('change', () => {
                let updatedChatrooms = user.chatrooms || [];
                if (checkbox.checked) {
                  if (!updatedChatrooms.includes(chatroomId)) {
                    updatedChatrooms.push(chatroomId);
                  }
                } else {
                  updatedChatrooms = updatedChatrooms.filter(id => id !== chatroomId);
                }
                db.collection('users').doc(userId).update({ chatrooms: updatedChatrooms })
                  .then(() => {
                    statusMessage.textContent = `Updated chatrooms for "${user.fullName}".`;
                    setTimeout(() => statusMessage.textContent = '', 3000);
                  })
                  .catch(error => alert('Error updating chatrooms: ' + error.message));
              });

              const label = document.createElement('label');
              label.htmlFor = checkbox.id;
              label.textContent = chatroomName;
              li.appendChild(checkbox);
              li.appendChild(label);
            });
          });

          membersList.appendChild(li);
        });
      });
    }
  </script>
</body>
</html>
