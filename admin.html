<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>YMF Admin Panel</title>
  <!-- Load Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=ABeeZee&family=Muli&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Muli', sans-serif;
      background-color: #fdfdfd;
      padding: 2rem;
      color: #000;
    }

    h1, h2, h3, h4 {
      font-family: 'ABeeZee', sans-serif;
      color: #8b1453;
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    li {
      padding: 0.5rem 0;
    }

    button {
      margin-left: 10px;
      padding: 4px 10px;
      background-color: #8b1453;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #a51863;
    }

    .error {
      color: red;
      font-weight: bold;
    }

    .section {
      margin-bottom: 2rem;
    }

    input {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>YMF Admin Panel</h1>
  <div id="error" class="error"></div>

  <div id="authSection">
    <button onclick="signIn()">Sign in with Google</button>
  </div>

  <div id="adminPanel" style="display: none;">
    <div class="section">
      <h2>Chatrooms</h2>
      <input type="text" id="newChatroomName" placeholder="New chatroom name">
      <button onclick="createChatroom()">Create Chatroom</button>
      <ul id="chatroomsList"></ul>
    </div>

    <div id="memberSection" style="display: none;" class="section">
      <h3 id="chatroomMembersTitle"></h3>
      <button id="returnToChatroomsBtn">Return to Chatrooms</button>
      <ul id="membersList"></ul>
    </div>

    <div class="section">
      <h2>Members Awaiting Approval</h2>
      <ul id="awaitingApprovalList"></ul>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCp94HHzIFiZh5kZREi7ZIVVL67IMnHEXw",
      authDomain: "ymf-messaging-platform.firebaseapp.com",
      projectId: "ymf-messaging-platform",
      storageBucket: "ymf-messaging-platform.firebasestorage.app",
      messagingSenderId: "820655157281",
      appId: "1:820655157281:web:9713621443c068abd73360"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const approvedAdmins = ["ian@ianchalkmusic.com", "sue.chalk@hotmail.co.uk"];
    let currentChatroomId = null;
    let currentChatroomName = "";

    const showError = msg => {
      document.getElementById('error').textContent = msg;
    };

    auth.onAuthStateChanged(user => {
      if (user && approvedAdmins.includes(user.email)) {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadData();
      } else if (user) {
        showError("Access denied: not an approved admin.");
      }
    });

    function signIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }

    async function loadData() {
      try {
        const chatroomsList = document.getElementById('chatroomsList');
        const membersList = document.getElementById('membersList');
        const awaitingApprovalList = document.getElementById('awaitingApprovalList');
        const chatroomMembersTitle = document.getElementById('chatroomMembersTitle');
        const returnToChatroomsBtn = document.getElementById('returnToChatroomsBtn');

        // Load chatrooms
        const chatroomsSnapshot = await db.collection('chatrooms').get();
        chatroomsList.innerHTML = '';
        chatroomsSnapshot.forEach(doc => {
          const chatroom = doc.data();
          const li = document.createElement('li');
          li.textContent = chatroom.name;

          const renameBtn = document.createElement('button');
          renameBtn.textContent = 'Rename';
          renameBtn.onclick = () => renameChatroom(doc.id, chatroom.name);

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.onclick = () => deleteChatroom(doc.id);

          const manageBtn = document.createElement('button');
          manageBtn.textContent = 'Manage Members';
          manageBtn.onclick = () => {
            currentChatroomId = doc.id;
            currentChatroomName = chatroom.name;
            loadData();
          };

          li.appendChild(manageBtn);
          li.appendChild(renameBtn);
          li.appendChild(deleteBtn);
          chatroomsList.appendChild(li);
        });

        // Load awaiting approval
        const awaitingSnapshot = await db.collection('members').where('approved', '==', false).get();
        awaitingApprovalList.innerHTML = '';
        awaitingSnapshot.forEach(doc => {
          const member = doc.data();
          const li = document.createElement('li');
          li.textContent = `${member.firstName} ${member.lastName} (${member.email})`;

          const approveBtn = document.createElement('button');
          approveBtn.textContent = 'Approve';
          approveBtn.onclick = () => approveMember(doc.id);

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.onclick = () => deleteMember(doc.id);

          li.appendChild(approveBtn);
          li.appendChild(deleteBtn);
          awaitingApprovalList.appendChild(li);
        });

        if (currentChatroomId) {
          document.getElementById('chatroomsList').style.display = 'none';
          document.getElementById('memberSection').style.display = 'block';
          chatroomMembersTitle.textContent = `Members in "${currentChatroomName}"`;
          returnToChatroomsBtn.style.display = 'inline-block';

          const approvedSnapshot = await db.collection('members').where('approved', '==', true).get();
          membersList.innerHTML = '';
          approvedSnapshot.forEach(doc => {
            const member = doc.data();
            const li = document.createElement('li');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = member.chatrooms?.includes(currentChatroomId);
            checkbox.onchange = () => toggleChatroomMembership(doc.id, checkbox.checked);
            li.appendChild(checkbox);
            li.appendChild(document.createTextNode(` ${member.firstName} ${member.lastName} (${member.email})`));
            membersList.appendChild(li);
          });
        } else {
          document.getElementById('chatroomsList').style.display = 'block';
          document.getElementById('memberSection').style.display = 'none';
          returnToChatroomsBtn.style.display = 'none';
        }

      } catch (error) {
        showError('Error loading data: ' + error.message);
      }
    }

    function returnToChatrooms() {
      currentChatroomId = null;
      currentChatroomName = "";
      loadData();
    }

    document.getElementById('returnToChatroomsBtn').onclick = returnToChatrooms;

    async function createChatroom() {
      const name = document.getElementById('newChatroomName').value.trim();
      if (!name) return;
      await db.collection('chatrooms').add({ name });
      document.getElementById('newChatroomName').value = '';
      loadData();
    }

    async function renameChatroom(id, oldName) {
      const newName = prompt("Enter new name for chatroom:", oldName);
      if (newName && newName !== oldName) {
        await db.collection('chatrooms').doc(id).update({ name: newName });
        loadData();
      }
    }

    async function deleteChatroom(id) {
      if (confirm("Are you sure you want to delete this chatroom?")) {
        await db.collection('chatrooms').doc(id).delete();
        loadData();
      }
    }

    async function approveMember(id) {
      await db.collection('members').doc(id).update({ approved: true });
      loadData();
    }

    async function deleteMember(id) {
      if (confirm("Are you sure you want to delete this member?")) {
        await db.collection('members').doc(id).delete();
        loadData();
      }
    }

    async function toggleChatroomMembership(memberId, isChecked) {
      const memberRef = db.collection('members').doc(memberId);
      const docSnap = await memberRef.get();
      const data = docSnap.data();
      let chatrooms = data.chatrooms || [];

      if (isChecked) {
        if (!chatrooms.includes(currentChatroomId)) {
          chatrooms.push(currentChatroomId);
        }
      } else {
        chatrooms = chatrooms.filter(id => id !== currentChatroomId);
      }

      await memberRef.update({ chatrooms });
    }
  </script>
</body>
</html>
