<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>YMF Admin Panel</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=ABeeZee&family=Muli&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Muli', sans-serif;
      background-color: #fdfdfd;
      padding: 2rem;
      color: #000;
    }
    h1, h2 {
      font-family: 'ABeeZee', sans-serif;
      color: #8b1453;
    }
    button {
      background-color: #8b1453;
      color: white;
      border: none;
      padding: 6px 12px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #a51863;
    }
    ul {
      list-style: none;
      padding-left: 0;
    }
    li {
      margin-bottom: 8px;
    }
    input[type="text"] {
      padding: 6px;
      margin-right: 6px;
    }
    .section {
      margin-bottom: 2rem;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>YMF Admin Panel</h1>
    <button onclick="window.location.href='index.html'">Return to Main Page</button>
  </div>
  <div id="error" class="error"></div>
  <div id="authSection">
    <button onclick="signIn()">Sign in with Google</button>
  </div>
  <div id="adminSection" style="display:none;">
    <div class="section">
      <h2>Chatrooms</h2>
      <ul id="chatroomList"></ul>
      <input type="text" id="newChatroomName" placeholder="New chatroom name">
      <button onclick="createChatroom()">Create Chatroom</button>
    </div>

    <div class="section" id="chatroomMembersSection" style="display:none;">
      <h2 id="selectedChatroomName">Chatroom</h2>
      <ul id="chatroomMembersList"></ul>
      <button onclick="returnToChatrooms()">Return to Chatrooms</button>
    </div>

    <div class="section">
      <h2>Members Awaiting Approval</h2>
      <ul id="awaitingList"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, setDoc, doc, deleteDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCp94HHzIFiZh5kZREi7ZIVVL67IMnHEXw",
      authDomain: "ymf-messaging-platform.firebaseapp.com",
      projectId: "ymf-messaging-platform",
      storageBucket: "ymf-messaging-platform.firebasestorage.app",
      messagingSenderId: "820655157281",
      appId: "1:820655157281:web:9713621443c068abd73360"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const approvedEmails = ["ian@ianchalkmusic.com", "sue.chalk@hotmail.co.uk"];

    const authSection = document.getElementById("authSection");
    const adminSection = document.getElementById("adminSection");
    const chatroomList = document.getElementById("chatroomList");
    const awaitingList = document.getElementById("awaitingList");
    const chatroomMembersList = document.getElementById("chatroomMembersList");
    const chatroomMembersSection = document.getElementById("chatroomMembersSection");
    const selectedChatroomName = document.getElementById("selectedChatroomName");
    const errorDiv = document.getElementById("error");

    let selectedChatroomId = null;

    function signIn() {
      signInWithPopup(auth, provider).catch(console.error);
    }

    onAuthStateChanged(auth, async (user) => {
      if (user && approvedEmails.includes(user.email)) {
        authSection.style.display = "none";
        adminSection.style.display = "block";
        loadData();
      } else {
        authSection.style.display = "block";
        adminSection.style.display = "none";
        if (user) {
          errorDiv.textContent = "Access denied: not an admin.";
        }
      }
    });

    async function loadData() {
      try {
        chatroomList.innerHTML = "";
        awaitingList.innerHTML = "";

        const chatroomSnap = await getDocs(collection(db, "chatrooms"));
        chatroomSnap.forEach(docSnap => {
          const li = document.createElement("li");
          li.textContent = docSnap.data().name;

          const manageBtn = document.createElement("button");
          manageBtn.textContent = "Manage Members";
          manageBtn.onclick = () => loadChatroomMembers(docSnap.id, docSnap.data().name);

          const renameBtn = document.createElement("button");
          renameBtn.textContent = "Rename";
          renameBtn.onclick = () => renameChatroom(docSnap.id, docSnap.data().name);

          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.onclick = () => deleteChatroom(docSnap.id);

          li.appendChild(manageBtn);
          li.appendChild(renameBtn);
          li.appendChild(delBtn);
          chatroomList.appendChild(li);
        });

        const memberSnap = await getDocs(collection(db, "members"));
        memberSnap.forEach(docSnap => {
          const data = docSnap.data();
          if (!data.approved) {
            const li = document.createElement("li");
            li.textContent = `${data.fullName} (${data.email})`;

            const approveBtn = document.createElement("button");
            approveBtn.textContent = "Approve";
            approveBtn.onclick = () => updateDoc(doc(db, "members", docSnap.id), { approved: true }).then(loadData);

            const delBtn = document.createElement("button");
            delBtn.textContent = "Delete";
            delBtn.onclick = () => deleteDoc(doc(db, "members", docSnap.id)).then(loadData);

            li.appendChild(approveBtn);
            li.appendChild(delBtn);
            awaitingList.appendChild(li);
          }
        });
      } catch (e) {
        errorDiv.textContent = "Error loading data: " + e.message;
      }
    }

    async function loadChatroomMembers(chatroomId, chatroomName) {
      selectedChatroomId = chatroomId;
      selectedChatroomName.textContent = `Assign Members to: ${chatroomName}`;
      chatroomMembersList.innerHTML = "";
      chatroomMembersSection.style.display = "block";

      const membersSnap = await getDocs(collection(db, "members"));
      membersSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.approved) {
          const li = document.createElement("li");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = data.chatrooms?.includes(chatroomId) || false;
          checkbox.onchange = () => {
            const updatedChatrooms = new Set(data.chatrooms || []);
            checkbox.checked ? updatedChatrooms.add(chatroomId) : updatedChatrooms.delete(chatroomId);
            updateDoc(doc(db, "members", docSnap.id), { chatrooms: Array.from(updatedChatrooms) }).then(loadData);
          };
          li.appendChild(checkbox);
          li.append(` ${data.fullName} (${data.email})`);
          chatroomMembersList.appendChild(li);
        }
      });
    }

    function returnToChatrooms() {
      selectedChatroomId = null;
      chatroomMembersSection.style.display = "none";
      loadData();
    }

    async function createChatroom() {
      const name = document.getElementById("newChatroomName").value.trim();
      if (!name) return alert("Chatroom name required.");
      const newRef = doc(collection(db, "chatrooms"));
      await setDoc(newRef, { name });
      document.getElementById("newChatroomName").value = "";
      loadData();
    }

    async function renameChatroom(id, oldName) {
      const newName = prompt("Rename chatroom:", oldName);
      if (newName && newName !== oldName) {
        await updateDoc(doc(db, "chatrooms", id), { name: newName });
        loadData();
      }
    }

    async function deleteChatroom(id) {
      if (confirm("Delete this chatroom?")) {
        await deleteDoc(doc(db, "chatrooms", id));
        const membersSnap = await getDocs(collection(db, "members"));
        for (const docSnap of membersSnap.docs) {
          const data = docSnap.data();
          if (data.chatrooms?.includes(id)) {
            const updated = data.chatrooms.filter(cid => cid !== id);
            await updateDoc(doc(db, "members", docSnap.id), { chatrooms: updated });
          }
        }
        loadData();
      }
    }
  </script>
</body>
</html>
