<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YMF Messaging Platform - Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 900px;
    }
    button {
      margin-left: 10px;
    }
    #errorMessage {
      color: red;
      margin-bottom: 20px;
    }
    ul {
      list-style-type: none;
      padding-left: 0;
    }
    li {
      margin-bottom: 8px;
    }
    #returnToChatroomsBtn {
      margin: 15px 0;
      display: none;
    }
    #memberSection {
      display: none;
    }
  </style>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>YMF Messaging Platform Admin Panel</h1>

<div id="errorMessage"></div>

<!-- Sign In / Sign Out Buttons -->
<div id="authSection">
  <button id="signInBtn">Sign in with Google</button>
  <button id="signOutBtn" style="display:none;">Sign out</button>
</div>

<!-- Chatrooms Section -->
<div id="chatroomsSection">
  <h2>Chatrooms</h2>
  <input type="text" id="newChatroomName" placeholder="New chatroom name" />
  <button id="createChatroomBtn">Create Chatroom</button>
  <ul id="chatroomsList"></ul>
</div>

<!-- Member Management Section -->
<div id="memberSection">
  <h2 id="chatroomMembersTitle"></h2>
  <button id="returnToChatroomsBtn">Return to Chatrooms</button>

  <h3>Members Assigned to Chatroom</h3>
  <ul id="membersList"></ul>

  <h3>Members Awaiting Approval</h3>
  <ul id="awaitingApprovalList"></ul>
</div>

<script>
  // Your Firebase config here (update with your config)
  const firebaseConfig = {
    apiKey: "AIzaSyCp94HHzIFiZh5kZREi7ZIVVL67IMnHEXw",
    authDomain: "ymf-messaging-platform.firebaseapp.com",
    projectId: "ymf-messaging-platform",
    storageBucket: "ymf-messaging-platform.appspot.com",
    messagingSenderId: "820655157281",
    appId: "1:820655157281:web:9713621443c068abd73360"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Elements
  const signInBtn = document.getElementById('signInBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const errorMessage = document.getElementById('errorMessage');
  const chatroomsList = document.getElementById('chatroomsList');
  const membersList = document.getElementById('membersList');
  const awaitingApprovalList = document.getElementById('awaitingApprovalList');
  const chatroomsSection = document.getElementById('chatroomsSection');
  const memberSection = document.getElementById('memberSection');
  const chatroomMembersTitle = document.getElementById('chatroomMembersTitle');
  const returnToChatroomsBtn = document.getElementById('returnToChatroomsBtn');
  const createChatroomBtn = document.getElementById('createChatroomBtn');
  const newChatroomName = document.getElementById('newChatroomName');

  let currentChatroomId = null;
  let currentChatroomName = '';

  // Show error
  function showError(message) {
    errorMessage.textContent = message;
  }

  // Clear error
  function clearError() {
    errorMessage.textContent = '';
  }

  // Authentication state observer
  auth.onAuthStateChanged(user => {
    if (user && (user.email === 'ian@ianchalkmusic.com' || user.email === 'sue.chalk@hotmail.co.uk')) {
      clearError();
      signInBtn.style.display = 'none';
      signOutBtn.style.display = 'inline-block';
      chatroomsSection.style.display = 'block';
      loadData();
    } else {
      signInBtn.style.display = 'inline-block';
      signOutBtn.style.display = 'none';
      chatroomsSection.style.display = 'none';
      memberSection.style.display = 'none';
      showError('Please sign in with an authorized admin Google account.');
    }
  });

  // Sign in with Google
  signInBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(error => {
      showError('Sign-in error: ' + error.message);
    });
  };

  // Sign out
  signOutBtn.onclick = () => {
    auth.signOut();
  };

  // Load chatrooms and members
  async function loadData() {
    clearError();

    if (!auth.currentUser) {
      showError('Not authenticated.');
      return;
    }

    try {
      // Load chatrooms
      const chatroomsSnapshot = await db.collection('chatrooms').get();
      chatroomsList.innerHTML = '';
      chatroomsSnapshot.forEach(doc => {
        const chatroom = doc.data();
        const li = document.createElement('li');
        li.textContent = chatroom.name;
        li.style.cursor = 'pointer';
        li.onclick = () => selectChatroom(doc.id, chatroom.name);

        // Add rename button
        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Rename';
        renameBtn.onclick = async (e) => {
          e.stopPropagation();
          const newName = prompt('Enter new name for chatroom:', chatroom.name);
          if (newName && newName.trim() !== '') {
            await db.collection('chatrooms').doc(doc.id).update({ name: newName.trim() });
            loadData();
          }
        };
        li.appendChild(renameBtn);

        // Add delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = async (e) => {
          e.stopPropagation();
          if (confirm(`Delete chatroom "${chatroom.name}"?`)) {
            await db.collection('chatrooms').doc(doc.id).delete();
            loadData();
          }
        };
        li.appendChild(deleteBtn);

        chatroomsList.appendChild(li);
      });

      // If a chatroom is selected, show members
      if (currentChatroomId) {
        chatroomsSection.style.display = 'none';
        memberSection.style.display = 'block';
        returnToChatroomsBtn.style.display = 'inline-block';
        chatroomMembersTitle.textContent = `Members in chatroom: ${currentChatroomName}`;
        await loadChatroomMembers(currentChatroomId);
      } else {
        chatroomsSection.style.display = 'block';
        memberSection.style.display = 'none';
        returnToChatroomsBtn.style.display = 'none';
      }

      // Load members awaiting approval
      const awaitingSnapshot = await db.collection('members').where('approved', '==', false).get();
      awaitingApprovalList.innerHTML = '';
      awaitingSnapshot.forEach(doc => {
        const member = doc.data();
        const li = document.createElement('li');
        li.textContent = `${member.firstName} ${member.lastName} (${member.email})`;

        // Approve button
        const approveBtn = document.createElement('button');
        approveBtn.textContent = 'Approve';
        approveBtn.onclick = () => approveMember(doc.id);
        li.appendChild(approveBtn);

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteMember(doc.id);
        li.appendChild(deleteBtn);

        awaitingApprovalList.appendChild(li);
      });

    } catch (error) {
      showError('Error loading data: ' + error.message);
    }
  }

  // Select a chatroom to manage members
  function selectChatroom(id, name) {
    currentChatroomId = id;
    currentChatroomName = name;
    loadData();
  }

  // Return to chatrooms list
  returnToChatroomsBtn.onclick = () => {
    currentChatroomId = null;
    currentChatroomName = '';
    loadData();
  };

  // Load approved members assigned to the selected chatroom
  async function loadChatroomMembers(chatroomId) {
    try {
      const approvedSnapshot = await db.collection('members').where('approved', '==', true).get();
      membersList.innerHTML = '';

      approvedSnapshot.forEach(doc => {
        const member = doc.data();
        if (member.chatrooms && member.chatrooms.includes(chatroomId)) {
          const li = document.createElement('li');
          li.textContent = `${member.firstName} ${member.lastName} (${member.email})`;

          // Checkbox to toggle chatroom membership
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = true;
          checkbox.onchange = () => toggleMemberChatroom(doc.id, chatroomId, checkbox.checked);
          li.prepend(checkbox);

          membersList.appendChild(li);
        }
      });
    } catch (error) {
      showError('Error loading chatroom members: ' + error.message);
    }
  }

  // Approve member
  async function approveMember(id) {
    clearError();
    try {
      await db.collection('members').doc(id).update({ approved: true });
      loadData();
    } catch (error) {
      showError('Error approving member: ' + error.message);
    }
  }

  // Delete member
  async function deleteMember(id) {
    clearError();
    if (!confirm('Are you sure you want to delete this member?')) return;
    try {
      await db.collection('members').doc(id).delete();
      loadData();
    } catch (error) {
      showError('Error deleting member: ' + error.message);
    }
  }

  // Toggle member chatroom assignment
  async function toggleMemberChatroom(memberId, chatroomId, assigned) {
    clearError();
    try {
      const memberRef = db.collection('members').doc(memberId);
      const memberDoc = await memberRef.get();
      if (!memberDoc.exists) {
        showError('Member not found');
        return;
      }
      let chatrooms = memberDoc.data().chatrooms || [];
      if (assigned) {
        if (!chatrooms.includes(chatroomId)) {
          chatrooms.push(chatroomId);
        }
      } else {
        chatrooms = chatrooms.filter(id => id !== chatroomId);
      }
      await memberRef.update({ chatrooms });
    } catch (error) {
      showError('Error updating chatroom assignment: ' + error.message);
    }
  }

  // Create new chatroom
  createChatroomBtn.onclick = async () => {
    const name = newChatroomName.value.trim();
    if (!name) {
      alert('Please enter a chatroom name.');
      return;
    }
    try {
      await db.collection('chatrooms').add({ name });
      newChatroomName.value = '';
      loadData();
    } catch (error) {
      showError('Error creating chatroom: ' + error.message);
    }
  };
</script>

</body>
</html>
