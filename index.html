<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YMF Messaging Platform</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Abeezee&family=Muli&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Muli', sans-serif;
      background: #fff;
      color: #000;
      margin: 0; padding: 0;
    }
    header {
      background-color: #8b1453;
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    header img {
      height: 40px;
    }
    header h1 {
      font-family: 'Abeezee', serif;
      margin: 0;
      font-size: 1.5rem;
    }
    main {
      padding: 1rem;
    }
    .hidden {
      display: none;
    }
    /* Sign In/Up forms */
    form {
      max-width: 320px;
      margin: 1rem auto;
      padding: 1rem;
      border: 1px solid #8b1453;
      border-radius: 6px;
      background: #fafafa;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: bold;
    }
    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width: 100%;
      padding: 0.4rem;
      margin-bottom: 0.75rem;
      border: 1px solid #8b1453;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      background-color: #8b1453;
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #6e0f3f;
    }
    .link-button {
      background: none;
      border: none;
      color: #8b1453;
      cursor: pointer;
      text-decoration: underline;
      font-size: 1rem;
      padding: 0;
      margin-top: 0.5rem;
    }
    /* Chatrooms list */
    #chatroomsList {
      max-width: 600px;
      margin: 1rem auto;
      border: 1px solid #8b1453;
      border-radius: 6px;
      background: #fff0f5;
      padding: 1rem;
    }
    #chatroomsList h2 {
      font-family: 'Abeezee', serif;
      color: #8b1453;
      margin-top: 0;
    }
    #chatroomsList ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #chatroomsList li {
      padding: 0.5rem;
      border-bottom: 1px solid #8b1453;
      cursor: pointer;
      color: #8b1453;
      font-weight: 600;
    }
    #chatroomsList li:hover {
      background-color: #f9d7e0;
    }
    /* Sign out link */
    #signOutBtn {
      background: none;
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      margin-left: auto;
    }
    /* Admin link */
    #adminLink {
      margin-left: 1rem;
      color: white;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="York Music Forum Logo" />
    <h1>YMF Messaging Platform</h1>
    <button id="signOutBtn" class="hidden">Sign Out</button>
    <a id="adminLink" href="admin.html" class="hidden" title="Admin Panel">Admin</a>
  </header>

  <main>
    <!-- Sign Up Form -->
    <form id="signUpForm">
      <h2>Sign Up</h2>
      <label for="signUpName">Full Name</label>
      <input type="text" id="signUpName" required />
      <label for="signUpEmail">Email</label>
      <input type="email" id="signUpEmail" required />
      <label for="signUpPassword">Password</label>
      <input type="password" id="signUpPassword" required />
      <button type="submit">Sign Up</button>
      <button type="button" id="switchToSignIn" class="link-button">Already have an account? Sign In</button>
      <p id="signUpMessage" style="color:red;"></p>
    </form>

    <!-- Sign In Form -->
    <form id="signInForm" class="hidden">
      <h2>Sign In</h2>
      <label for="signInEmail">Email</label>
      <input type="email" id="signInEmail" required />
      <label for="signInPassword">Password</label>
      <input type="password" id="signInPassword" required />
      <button type="submit">Sign In</button>
      <button type="button" id="switchToSignUp" class="link-button">Don't have an account? Sign Up</button>
      <p id="signInMessage" style="color:red;"></p>
    </form>

    <!-- Chatrooms List -->
    <section id="chatroomsList" class="hidden">
      <h2>Select a Chatroom</h2>
      <ul id="chatroomsUl"></ul>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    // Your Firebase configuration (replace with your actual config)
    const firebaseConfig = {
      apiKey: "AIzaSyCp94HHzIFiZh5kZREi7ZIVVL67IMnHEXw",
      authDomain: "ymf-messaging-platform.firebaseapp.com",
      projectId: "ymf-messaging-platform",
      storageBucket: "ymf-messaging-platform.appspot.com",
      messagingSenderId: "820655157281",
      appId: "1:820655157281:web:9713621443c068abd73360"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const signUpForm = document.getElementById('signUpForm');
    const signInForm = document.getElementById('signInForm');
    const switchToSignInBtn = document.getElementById('switchToSignIn');
    const switchToSignUpBtn = document.getElementById('switchToSignUp');
    const signOutBtn = document.getElementById('signOutBtn');
    const adminLink = document.getElementById('adminLink');
    const chatroomsList = document.getElementById('chatroomsList');
    const chatroomsUl = document.getElementById('chatroomsUl');
    const signUpMessage = document.getElementById('signUpMessage');
    const signInMessage = document.getElementById('signInMessage');

    // Show/hide forms
    function showSignUp() {
      signUpForm.classList.remove('hidden');
      signInForm.classList.add('hidden');
      chatroomsList.classList.add('hidden');
      signOutBtn.classList.add('hidden');
      adminLink.classList.add('hidden');
      clearMessages();
    }
    function showSignIn() {
      signInForm.classList.remove('hidden');
      signUpForm.classList.add('hidden');
      chatroomsList.classList.add('hidden');
      signOutBtn.classList.add('hidden');
      adminLink.classList.add('hidden');
      clearMessages();
    }
    function showChatrooms() {
      signUpForm.classList.add('hidden');
      signInForm.classList.add('hidden');
      chatroomsList.classList.remove('hidden');
      signOutBtn.classList.remove('hidden');
      clearMessages();
    }
    function clearMessages() {
      signUpMessage.textContent = '';
      signInMessage.textContent = '';
    }

    // Switch buttons
    switchToSignInBtn.addEventListener('click', showSignIn);
    switchToSignUpBtn.addEventListener('click', showSignUp);

    // Password hashing (simple SHA-256) helper function
    async function hashPassword(password) {
      const msgUint8 = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Sign Up handler
    signUpForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();

      const name = document.getElementById('signUpName').value.trim();
      const email = document.getElementById('signUpEmail').value.trim().toLowerCase();
      const password = document.getElementById('signUpPassword').value;

      if (!name || !email || !password) {
        signUpMessage.textContent = 'Please fill in all fields.';
        return;
      }

      try {
        // Check if user already exists in 'users' collection
        const userDoc = await db.collection('users').doc(email).get();
        if (userDoc.exists) {
          signUpMessage.textContent = 'An account with this email already exists.';
          return;
        }

        const passwordHash = await hashPassword(password);

        // Create user document (approved = false by default)
        await db.collection('users').doc(email).set({
          fullName: name,
          email: email,
          passwordHash: passwordHash,
          approved: false,
          admin: false,
          chatrooms: []
        });

        signUpMessage.style.color = 'green';
        signUpMessage.textContent = 'Sign up successful! Await admin approval.';
        signUpForm.reset();

      } catch (error) {
        signUpMessage.textContent = 'Error signing up: ' + error.message;
      }
    });

    // Sign In handler
    signInForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();

      const email = document.getElementById('signInEmail').value.trim().toLowerCase();
      const password = document.getElementById('signInPassword').value;

      if (!email || !password) {
        signInMessage.textContent = 'Please enter email and password.';
        return;
      }

      try {
        const userDoc = await db.collection('users').doc(email).get();
        if (!userDoc.exists) {
          signInMessage.textContent = 'No account found with this email.';
          return;
        }

        const userData = userDoc.data();

        if (!userData.approved) {
          signInMessage.textContent = 'Your account is not approved yet.';
          return;
        }

        const passwordHash = await hashPassword(password);

        if (passwordHash !== userData.passwordHash) {
          signInMessage.textContent = 'Incorrect password.';
          return;
        }

        // Store current user info in sessionStorage for session
        sessionStorage.setItem('ymfUser', JSON.stringify({
          email: userData.email,
          fullName: userData.fullName,
          admin: userData.admin,
          chatrooms: userData.chatrooms || []
        }));

        loadChatrooms(userData.chatrooms || []);
        showChatrooms();

        // Show admin link if admin
        if (userData.admin) {
          adminLink.classList.remove('hidden');
        } else {
          adminLink.classList.add('hidden');
        }

      } catch (error) {
        signInMessage.textContent = 'Error signing in: ' + error.message;
      }
    });

    // Load chatrooms user is assigned to
    async function loadChatrooms(userChatrooms) {
      chatroomsUl.innerHTML = '';
      if (!userChatrooms.length) {
        chatroomsUl.innerHTML = '<li>You are not assigned to any chatrooms yet.</li>';
        return;
      }
      try {
        for (const chatroomId of userChatrooms) {
          const chatroomDoc = await db.collection('chatrooms').doc(chatroomId).get();
          if (chatroomDoc.exists) {
            const chatroom = chatroomDoc.data();
            const li = document.createElement('li');
            li.textContent = chatroom.name;
            li.dataset.chatroomId = chatroomId;
            li.addEventListener('click', () => {
              // Redirect to chatroom page (you can replace with your chatroom URL)
              window.location.href = `chatroom.html?id=${chatroomId}`;
            });
            chatroomsUl.appendChild(li);
          }
        }
      } catch (error) {
        chatroomsUl.innerHTML = `<li>Error loading chatrooms: ${error.message}</li>`;
      }
    }

    // Sign Out handler
    signOutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('ymfUser');
      adminLink.classList.add('hidden');
      showSignIn();
    });

    // On page load: check session
    window.addEventListener('load', () => {
      const user = sessionStorage.getItem('ymfUser');
      if (user) {
        const userData = JSON.parse(user);
        loadChatrooms(userData.chatrooms || []);
        showChatrooms();
        if (userData.admin) {
          adminLink.classList.remove('hidden');
        }
      } else {
        showSignUp();
      }
    });
  </script>
</body>
</html>
