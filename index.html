<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YMF Messaging Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=ABeeZee&family=Muli&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Muli', sans-serif;
      margin: 0;
      padding: 0;
      background: #fff;
      color: #000;
    }
    header {
      background: #8b1453;
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header img {
      height: 50px;
    }
    h1 {
      font-family: 'ABeeZee', sans-serif;
      margin: 0;
    }
    main {
      padding: 1rem;
    }
    .hidden {
      display: none;
    }
    .chatroom-list button {
      display: block;
      margin: 0.5rem 0;
      padding: 0.5rem;
      background-color: #eee;
      border: none;
      cursor: pointer;
    }
    .message-area {
      border-top: 1px solid #ccc;
      margin-top: 1rem;
      padding-top: 1rem;
    }
    .logout {
      margin-top: 1rem;
      color: #8b1453;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/ymf-logo.png" alt="York Music Forum Logo" />
    <h1>YMF Messaging Platform</h1>
    <button id="adminLink" class="hidden">Admin Panel</button>
  </header>

  <main>
    <div id="authSection">
      <h2>Sign In</h2>
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Password" required />
      <button id="signInButton">Sign In</button>
      <p id="authMessage"></p>
    </div>

    <div id="chatroomSection" class="hidden">
      <h2>Your Chatrooms</h2>
      <div class="chatroom-list" id="chatroomList"></div>
      <div class="message-area hidden" id="messageArea">
        <h3 id="chatroomTitle"></h3>
        <div id="messages"></div>
        <input type="text" id="newMessage" placeholder="Type a message" />
        <button id="sendMessage">Send</button>
        <button id="backToChatrooms">Return to Chatrooms</button>
      </div>
      <div class="logout" id="logout">Logout</div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCp94HHzIFiZh5kZREi7ZIVVL67IMnHEXw",
      authDomain: "ymf-messaging-platform.firebaseapp.com",
      projectId: "ymf-messaging-platform",
      storageBucket: "ymf-messaging-platform.appspot.com",
      messagingSenderId: "820655157281",
      appId: "1:820655157281:web:9713621443c068abd73360"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const signInButton = document.getElementById("signInButton");
    const authMessage = document.getElementById("authMessage");
    const authSection = document.getElementById("authSection");
    const chatroomSection = document.getElementById("chatroomSection");
    const chatroomList = document.getElementById("chatroomList");
    const messageArea = document.getElementById("messageArea");
    const chatroomTitle = document.getElementById("chatroomTitle");
    const messagesDiv = document.getElementById("messages");
    const newMessage = document.getElementById("newMessage");
    const sendMessage = document.getElementById("sendMessage");
    const backToChatrooms = document.getElementById("backToChatrooms");
    const logout = document.getElementById("logout");
    const adminLink = document.getElementById("adminLink");

    let currentUserDoc;
    let currentChatroom = null;

    signInButton.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) return;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        const userQuery = query(collection(db, "users"), where("email", "==", email));
        const userSnap = await getDocs(userQuery);

        if (userSnap.empty) {
          authMessage.textContent = "No account found with this email.";
          return;
        }

        const docData = userSnap.docs[0].data();
        currentUserDoc = userSnap.docs[0];

        if (!docData.approved) {
          authMessage.textContent = "Your account is awaiting approval.";
          return;
        }

        authSection.classList.add("hidden");
        chatroomSection.classList.remove("hidden");

        if (docData.admin) {
          adminLink.classList.remove("hidden");
          adminLink.addEventListener("click", () => {
            window.location.href = "admin.html";
          });
        }

        loadChatrooms(docData.chatrooms || []);
      } catch (error) {
        console.error(error);
        authMessage.textContent = "Sign in failed.";
      }
    });

    function loadChatrooms(chatrooms) {
      chatroomList.innerHTML = "";
      chatrooms.forEach(roomId => {
        const btn = document.createElement("button");
        btn.textContent = roomId;
        btn.addEventListener("click", () => enterChatroom(roomId));
        chatroomList.appendChild(btn);
      });
    }

    function enterChatroom(roomId) {
      currentChatroom = roomId;
      chatroomTitle.textContent = roomId;
      messageArea.classList.remove("hidden");
      chatroomList.classList.add("hidden");
      const messagesRef = collection(db, "chatrooms", roomId, "messages");
      const q = query(messagesRef, orderBy("timestamp"));
      onSnapshot(q, snapshot => {
        messagesDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const p = document.createElement("p");
          p.textContent = doc.data().text;
          messagesDiv.appendChild(p);
        });
      });
    }

    sendMessage.addEventListener("click", async () => {
      const text = newMessage.value.trim();
      if (!text || !currentChatroom) return;
      const messagesRef = collection(db, "chatrooms", currentChatroom, "messages");
      await addDoc(messagesRef, {
        text,
        timestamp: new Date()
      });
      newMessage.value = "";
    });

    backToChatrooms.addEventListener("click", () => {
      messageArea.classList.add("hidden");
      chatroomList.classList.remove("hidden");
    });

    logout.addEventListener("click", () => {
      location.reload();
    });
  </script>
</body>
</html>

